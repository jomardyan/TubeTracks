name: Publish to PyPI

# This workflow publishes the package to PyPI
# It ONLY runs when manually triggered via workflow_dispatch
# Requires PYPI_API_TOKEN secret to be configured

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Publish to production PyPI or test TestPyPI'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi
      skip_tests:
        description: 'Skip running tests before publishing (not recommended)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write  # Required for trusted publishing (future enhancement)

env:
  PYTHON_VERSION: '3.12'

jobs:
  validate:
    name: Validate Package Before Publishing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run tests
      if: ${{ !inputs.skip_tests }}
      run: |
        echo "ðŸ§ª Running test suite..."
        pytest tests/ -v --tb=short || {
          echo "âŒ Tests failed! Cannot publish package with failing tests."
          echo ""
          echo "Run tests locally with: make test"
          exit 1
        }
        echo "âœ… All tests passed"

    - name: Validate package configuration
      run: |
        echo "Validating pyproject.toml..."
        
        # Check required files
        test -f pyproject.toml || (echo "âŒ pyproject.toml missing" && exit 1)
        test -f README.md || (echo "âŒ README.md missing" && exit 1)
        test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
        test -f CHANGELOG.md || (echo "âŒ CHANGELOG.md missing" && exit 1)
        
        # Check core modules
        test -f downloader.py || (echo "âŒ downloader.py missing" && exit 1)
        test -f tubetracks_gui.py || (echo "âŒ tubetracks_gui.py missing" && exit 1)
        test -d plugins || (echo "âŒ plugins/ directory missing" && exit 1)
        
        echo "âœ… All required files present"

  build:
    name: Build Distribution Packages
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip "setuptools>=77.0.0" wheel
        pip install build "twine>=6.1.0"

    - name: Build distributions
      run: |
        echo "ðŸ“¦ Building distribution packages..."
        python -m build --verbose
        
        echo ""
        echo "âœ… Build complete"
        echo ""
        echo "Generated files:"
        ls -lh dist/

    - name: Validate distributions with twine
      run: |
        echo "ðŸ” Validating distribution packages..."
        python -m twine check dist/* --strict
        
        echo ""
        echo "âœ… All distributions validated successfully"

    - name: Display package metadata
      run: |
        echo "ðŸ“‹ Package Information:"
        echo ""
        
        # Extract version from pyproject.toml
        VERSION=$(python -c "import tomllib; f=open('pyproject.toml','rb'); print(tomllib.load(f)['project']['version'])" 2>/dev/null || \
                  python -c "import tomli; f=open('pyproject.toml','rb'); print(tomli.load(f)['project']['version'])" 2>/dev/null || \
                  grep "^version" pyproject.toml | cut -d'"' -f2)
        
        NAME=$(python -c "import tomllib; f=open('pyproject.toml','rb'); print(tomllib.load(f)['project']['name'])" 2>/dev/null || \
               python -c "import tomli; f=open('pyproject.toml','rb'); print(tomli.load(f)['project']['name'])" 2>/dev/null || \
               grep "^name" pyproject.toml | cut -d'"' -f2)
        
        echo "  Package: $NAME"
        echo "  Version: $VERSION"
        echo "  Target:  ${{ inputs.environment }}"
        echo ""
        
        if [ "${{ inputs.environment }}" == "pypi" ]; then
          echo "âš ï¸  WARNING: Publishing to PRODUCTION PyPI"
          echo "   This version will be PERMANENT and cannot be deleted!"
          echo "   Make sure the version number is correct: $VERSION"
        else
          echo "â„¹ï¸  Publishing to TEST PyPI (testpypi)"
          echo "   This is a safe testing environment"
        fi

    - name: Upload distributions as artifact
      uses: actions/upload-artifact@v4
      with:
        name: python-distributions
        path: dist/
        retention-days: 7

  publish:
    name: Publish to ${{ inputs.environment }}
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'pypi' && 'https://pypi.org/project/tubetracks/' || 'https://test.pypi.org/project/tubetracks/' }}
    
    steps:
    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: python-distributions
        path: dist/

    - name: Display files to be published
      run: |
        echo "ðŸ“¦ Files to be published:"
        ls -lh dist/
        echo ""
        echo "Publishing to: ${{ inputs.environment }}"

    - name: Publish to Test PyPI
      if: inputs.environment == 'testpypi'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        TWINE_REPOSITORY: testpypi
      run: |
        pip install twine
        
        echo "ðŸ“¤ Publishing to Test PyPI..."
        python -m twine upload dist/* --verbose --skip-existing || {
          echo ""
          echo "âŒ Publication to Test PyPI failed"
          echo ""
          echo "Common causes:"
          echo "  â€¢ Missing or invalid TEST_PYPI_API_TOKEN secret"
          echo "  â€¢ Version already exists on Test PyPI"
          echo "  â€¢ Network issues"
          echo ""
          echo "Check the error message above for details"
          exit 1
        }
        
        echo ""
        echo "âœ… Successfully published to Test PyPI!"
        echo ""
        echo "ðŸ”— View at: https://test.pypi.org/project/tubetracks/"
        echo ""
        echo "Test installation with:"
        echo "  pip install -i https://test.pypi.org/simple/ tubetracks"

    - name: Publish to Production PyPI
      if: inputs.environment == 'pypi'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        TWINE_REPOSITORY: pypi
      run: |
        pip install twine
        
        echo "âš ï¸  Publishing to PRODUCTION PyPI..."
        echo "   This action is PERMANENT and IRREVERSIBLE!"
        echo ""
        
        python -m twine upload dist/* --verbose --skip-existing || {
          echo ""
          echo "âŒ Publication to PyPI failed"
          echo ""
          echo "Common causes:"
          echo "  â€¢ Missing or invalid PYPI_API_TOKEN secret"
          echo "  â€¢ Version already exists on PyPI (cannot overwrite)"
          echo "  â€¢ Invalid package metadata"
          echo "  â€¢ Network issues"
          echo ""
          echo "Check the error message above for details"
          exit 1
        }
        
        echo ""
        echo "ðŸŽ‰ Successfully published to PyPI!"
        echo ""
        echo "ðŸ”— View at: https://pypi.org/project/tubetracks/"
        echo ""
        echo "Install with:"
        echo "  pip install tubetracks"

  verify:
    name: Verify Publication
    needs: publish
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: always()
    
    steps:
    - name: Wait for package to be indexed
      run: |
        echo "â³ Waiting 30 seconds for package to be indexed..."
        sleep 30

    - name: Verify package is available (TestPyPI)
      if: inputs.environment == 'testpypi'
      run: |
        echo "ðŸ” Checking if package is available on Test PyPI..."
        
        pip install --upgrade pip
        
        # Try to install from TestPyPI
        pip install -i https://test.pypi.org/simple/ tubetracks --dry-run || {
          echo "âš ï¸  Package not yet available on Test PyPI"
          echo "   This is normal - indexing can take a few minutes"
          echo ""
          echo "Manual verification:"
          echo "  Visit: https://test.pypi.org/project/tubetracks/"
        }

    - name: Verify package is available (PyPI)
      if: inputs.environment == 'pypi'
      run: |
        echo "ðŸ” Checking if package is available on PyPI..."
        
        pip install --upgrade pip
        
        # Try to fetch package info from PyPI
        pip index versions tubetracks || {
          echo "âš ï¸  Package not yet fully indexed on PyPI"
          echo "   This is normal - indexing can take a few minutes"
          echo ""
          echo "Manual verification:"
          echo "  Visit: https://pypi.org/project/tubetracks/"
        }

    - name: Summary
      run: |
        echo "### ðŸ“¦ Package Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.environment }}" == "pypi" ]; then
          echo "âœ… **Successfully published to PyPI**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **View**: [https://pypi.org/project/tubetracks/](https://pypi.org/project/tubetracks/)" >> $GITHUB_STEP_SUMMARY
          echo "- **Install**: \`pip install tubetracks\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Successfully published to Test PyPI**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **View**: [https://test.pypi.org/project/tubetracks/](https://test.pypi.org/project/tubetracks/)" >> $GITHUB_STEP_SUMMARY
          echo "- **Install**: \`pip install -i https://test.pypi.org/simple/ tubetracks\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.environment }}" == "testpypi" ]; then
          echo "1. Test the package installation" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all functionality works" >> $GITHUB_STEP_SUMMARY
          echo "3. When ready, publish to production PyPI" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. Verify the package on PyPI" >> $GITHUB_STEP_SUMMARY
          echo "2. Test installation: \`pip install tubetracks\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          echo "4. Announce the release!" >> $GITHUB_STEP_SUMMARY
        fi
